@model CRUDDEMO1.Models.Employee

@{
    ViewData["Title"] = "Employee tahrirlash";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">@ViewData["Title"]</h2>

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <form asp-action="Edit" method="post" id="employeeForm">
                @Html.AntiForgeryToken()
                @Html.HiddenFor(model => model.Id)
                <input type="hidden" name="deletedChildrenIds" id="deletedChildrenIds" value="" />

                <!-- Employee Ma'lumotlari -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Employee Ma'lumotlari</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Name" class="form-label">Ism</label>
                                    <input asp-for="Name" class="form-control" />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Gender" class="form-label">Jins</label>
                                    <select asp-for="Gender" class="form-control">
                                        <option value="">Tanlang...</option>
                                        <option value="Erkak">Erkak</option>
                                        <option value="Ayol">Ayol</option>
                                    </select>
                                    <span asp-validation-for="Gender" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Company" class="form-label">Kompaniya</label>
                                    <input asp-for="Company" class="form-control" />
                                    <span asp-validation-for="Company" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Department" class="form-label">Bo'lim</label>
                                    <input asp-for="Department" class="form-control" />
                                    <span asp-validation-for="Department" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Children Ma'lumotlari -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Bolalar Ma'lumotlari</h4>
                        <button type="button" class="btn btn-light btn-sm" onclick="addNewChild()">
                            <i class="fas fa-plus"></i> Yangi bola qo'shish
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="childrenContainer">
                            @if (Model.Children != null && Model.Children.Count > 0)
                            {
                                for (int i = 0; i < Model.Children.Count; i++)
                                {
                                    <div class="child-item border rounded p-3 mb-3" data-child-index="@i">
                                        @Html.HiddenFor(m => m.Children[i].Id)
                                        @Html.HiddenFor(m => m.Children[i].EmployeeId)

                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group mb-2">
                                                    <label class="form-label">Ism</label>
                                                    @Html.TextBoxFor(m => m.Children[i].Name, new { @class = "form-control child-name" })
                                                    <span asp-validation-for="@Model.Children[i].Name" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group mb-2">
                                                    <label class="form-label">Jins</label>
                                                    @Html.DropDownListFor(m => m.Children[i].Gender,
                                                    new SelectList(new[] {
                                                                                        new { Value = "", Text = "Tanlang..." },
                                                                                        new { Value = "Erkak", Text = "Erkak" },
                                                                                        new { Value = "Ayol", Text = "Ayol" }
                                                                                        }, "Value", "Text"),
                                                                                        new { @class = "form-control child-gender" })
                                        </div>
                                    </div>
                                    <div class="col-md-1">
                                        <div class="form-group mb-2">
                                            <label class="form-label">Yosh</label>
                                            @Html.TextBoxFor(m => m.Children[i].Age, new { @class = "form-control child-age", type = "number", min = "0", max = "30" })
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-2">
                                            <label class="form-label">Maktab</label>
                                            @Html.TextBoxFor(m => m.Children[i].School, new { @class = "form-control child-school" })
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group mb-2">
                                            <label class="form-label">Sinf</label>
                                            @Html.TextBoxFor(m => m.Children[i].Grade, new { @class = "form-control child-grade" })
                                        </div>
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger btn-sm mb-2"
                                                onclick="removeChildDebug(this, @Model.Children[i].Id)"
                                                title="O'chirish"
                                                data-child-id="@Model.Children[i].Id">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                                                        }
                                                        }
                                                        else
                            {
                                <div class="text-center text-muted">
                                    <p>Hech qanday bola ma'lumotlari yo'q</p>
                                    <button type="button" class="btn btn-primary" onclick="addNewChild()">
                                        Birinchi bola ma'lumotini qo'shish
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-group text-center">
                    <button type="submit" class="btn btn-success btn-lg me-3">
                        <i class="fas fa-save"></i> Saqlash
                    </button>
                    <a asp-action="Index" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-left"></i> Orqaga
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- New Child Template (hidden) -->
<div id="newChildTemplate" style="display: none;">
    <div class="child-item border rounded p-3 mb-3" data-child-index="{INDEX}">
        <input type="hidden" name="Children[{INDEX}].Id" value="0" />
        <input type="hidden" name="Children[{INDEX}].EmployeeId" value="@Model.Id" />

        <div class="row">
            <div class="col-md-3">
                <div class="form-group mb-2">
                    <label class="form-label">Ism</label>
                    <input name="Children[{INDEX}].Name" class="form-control child-name" />
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group mb-2">
                    <label class="form-label">Jins</label>
                    <select name="Children[{INDEX}].Gender" class="form-control child-gender">
                        <option value="">Tanlang...</option>
                        <option value="Erkak">Erkak</option>
                        <option value="Ayol">Ayol</option>
                    </select>
                </div>
            </div>
            <div class="col-md-1">
                <div class="form-group mb-2">
                    <label class="form-label">Yosh</label>
                    <input name="Children[{INDEX}].Age" class="form-control child-age" type="number" min="0" max="30" value="0" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group mb-2">
                    <label class="form-label">Maktab</label>
                    <input name="Children[{INDEX}].School" class="form-control child-school" />
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group mb-2">
                    <label class="form-label">Sinf</label>
                    <input name="Children[{INDEX}].Grade" class="form-control child-grade" />
                </div>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-danger btn-sm mb-2"
                        onclick="removeChildDebug(this, 0)"
                        title="O'chirish"
                        data-child-id="0">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let childIndex = @(Model.Children?.Count ?? 0);
        let deletedChildrenIds = [];

        function addNewChild() {
            const template = document.getElementById('newChildTemplate').innerHTML;
            const newChildHtml = template.replace(/{INDEX}/g, childIndex);

            const container = document.getElementById('childrenContainer');

            // Agar container bo'sh bo'lsa, birinchi child qo'shishda text-center div'ni o'chirish
            const emptyMessage = container.querySelector('.text-center.text-muted');
            if (emptyMessage) {
                emptyMessage.remove();
            }

            container.insertAdjacentHTML('beforeend', newChildHtml);
            childIndex++;
        }

        function removeChild(button, childId) {
            console.log('Removing child with ID:', childId); // Debug uchun

            if (confirm('Haqiqatan ham bu bola ma\'lumotlarini o\'chirmoqchimisiz?')) {
                const childItem = button.closest('.child-item');

                // Agar bu mavjud child bo'lsa (ID > 0), deleted list'ga qo'shish
                if (childId && childId > 0) {
                    deletedChildrenIds.push(childId);
                    document.getElementById('deletedChildrenIds').value = deletedChildrenIds.join(',');
                    console.log('Deleted IDs:', deletedChildrenIds); // Debug uchun
                }

                // DOM'dan o'chirish
                childItem.remove();

                // Agar barcha children'lar o'chirilsa, empty message ko'rsatish
                const container = document.getElementById('childrenContainer');
                if (container.children.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted">
                            <p>Hech qanday bola ma'lumotlari yo'q</p>
                            <button type="button" class="btn btn-primary" onclick="addNewChild()">
                                Birinchi bola ma'lumotini qo'shish
                            </button>
                        </div>`;
                }

                // Index'larni qayta raqamlash
                reindexChildren();

                console.log('Child removed successfully'); // Debug uchun
            }
        }

        function reindexChildren() {
            const childItems = document.querySelectorAll('.child-item');
            childItems.forEach((item, index) => {
                item.setAttribute('data-child-index', index);

                // Input name'larni yangilash
                const inputs = item.querySelectorAll('input, select');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name && name.includes('Children[')) {
                        const newName = name.replace(/Children\[\d+\]/, `Children[${index}]`);
                        input.setAttribute('name', newName);
                    }
                });
            });

            childIndex = childItems.length;
        }

        // Form submit qilishdan oldin validation va debug
        document.getElementById('employeeForm').addEventListener('submit', function(e) {
            console.log('=== FORM SUBMIT DEBUG ===');
            console.log('Deleted children IDs:', document.getElementById('deletedChildrenIds').value);

            const childItems = document.querySelectorAll('.child-item');
            console.log('Total children in form:', childItems.length);

            let hasInvalidChild = false;

            childItems.forEach((item, index) => {
                const name = item.querySelector('.child-name').value.trim();
                const gender = item.querySelector('.child-gender').value;
                const age = item.querySelector('.child-age').value;

                console.log(`Child ${index}: Name="${name}", Gender="${gender}", Age="${age}"`);

                if (name && (!gender || !age)) {
                    hasInvalidChild = true;
                }
            });

            console.log('Has invalid child:', hasInvalidChild);
            console.log('=== FORM SUBMIT DEBUG END ===');

            if (hasInvalidChild) {
                e.preventDefault();
                alert('Iltimos, barcha bola ma\'lumotlarini to\'ldiring yoki bo\'sh maydonlarni o\'chiring');
            }
        });
    </script>
}